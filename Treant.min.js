(function(){var l={inheritAttrs:function(a,b){for(var c in b)"function"!==typeof b[c]&&(a[c]instanceof Object&&b[c]instanceof Object?this.inheritAttrs(a[c],b[c]):a[c]=b[c])},createMerge:function(a,b){var c={};a&&this.inheritAttrs(c,this.cloneObj(a));b&&this.inheritAttrs(c,b);return c},cloneObj:function(a){if(Object(a)!==a)return a;var b=new a.constructor,c;for(c in a)a.hasOwnProperty(c)&&(b[c]=this.cloneObj(a[c]));return b},addEvent:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?
a.attachEvent("on"+b,c):a["on"+b]=c},hasClass:function(a,b){return-1<(" "+a.className+" ").replace(/[\n\t]/g," ").indexOf(" "+b+" ")}},t=function(){this.loading=[]};t.prototype={processNode:function(a){for(var b=a.nodeDOM.getElementsByTagName("img"),c=b.length;c--;)this.create(a,b[c])},removeAll:function(a){for(var b=this.loading.length;b--;)this.loading[b]===a&&this.loading.splice(b,1)},create:function(a,b){function c(){d.removeAll(e);a.width=a.nodeDOM.offsetWidth;a.height=a.nodeDOM.offsetHeight}
var d=this,e=b.src;this.loading.push(e);if(b.complete)return c();l.addEvent(b,"load",c);l.addEvent(b,"error",c);b.src+="?"+(new Date).getTime()},isNotLoading:function(){return 0===this.loading.length}};var s={store:[],createTree:function(a){this.store.push(new r(a,this.store.length));return this.store[this.store.length-1]},get:function(a){return this.store[a]},destroy:function(a){var b=this.get(a);if(b){b._R.remove();for(b=b.drawArea;b.firstChild;)b.removeChild(b.firstChild);for(var c=b.className.split(" "),
d=[],e=0;e<c.length;e++){var j=c[e];"Treant"!=j&&"Treant-loaded"!=j&&d.push(j)}b.style.overflowY="";b.style.overflowX="";b.className=d.join(" ");this.store[a]=null}}},r=function(a,b){this.id=b;this.imageLoader=new t;this.CONFIG=l.createMerge(r.CONFIG,a.chart);this.drawArea=document.getElementById(this.CONFIG.container.substring(1));this.drawArea.className+=" Treant";this.nodeDB=new u(a.nodeStructure,this);this.connectionStore={}};r.prototype={positionTree:function(a){var b=this;if(this.imageLoader.isNotLoading()){var c=
this.root();this.resetLevelData();this.firstWalk(c,0);this.secondWalk(c,0,0,0);this.positionNodes();this.CONFIG.animateOnInit&&setTimeout(function(){c.toggleCollapse()},this.CONFIG.animateOnInitDelay);this.loaded||(this.drawArea.className+=" Treant-loaded","[object Function]"===Object.prototype.toString.call(a)&&a(b),this.loaded=!0)}else setTimeout(function(){b.positionTree(a)},10)},firstWalk:function(a,b){a.prelim=null;a.modifier=null;this.setNeighbors(a,b);this.calcLevelDim(a,b);var c=a.leftSibling();
if(0===a.childrenCount()||b==this.CONFIG.maxDepth)a.prelim=c?c.prelim+c.size()+this.CONFIG.siblingSeparation:0;else{for(var d=0,e=a.childrenCount();d<e;d++)this.firstWalk(a.childAt(d),b+1);d=a.childrenCenter()-a.size()/2;c?(a.prelim=c.prelim+c.size()+this.CONFIG.siblingSeparation,a.modifier=a.prelim-d,this.apportion(a,b)):a.prelim=d;a.stackParent?a.modifier+=this.nodeDB.get(a.stackChildren[0]).size()/2+a.connStyle.stackIndent:a.stackParentId&&(a.prelim=0)}},apportion:function(a,b){for(var c=a.firstChild(),
d=c.leftNeighbor(),e=1,j=this.CONFIG.maxDepth-b;c&&d&&e<=j;){for(var f=0,h=0,g=d,i=c,k=0;k<e;k++)g=g.parent(),i=i.parent(),h+=g.modifier,f+=i.modifier,void 0!==i.stackParent&&(f+=i.size()/2);f=d.prelim+h+d.size()+this.CONFIG.subTeeSeparation-(c.prelim+f);if(0<f){i=a;for(h=0;i&&i.id!=g.id;)i=i.leftSibling(),h++;if(i){i=a;for(h=f/h;i.id!=g.id;)i.prelim+=f,i.modifier+=f,f-=h,i=i.leftSibling()}}e++;(c=0===c.childrenCount()?a.leftMost(0,e):c.firstChild())&&(d=c.leftNeighbor())}},secondWalk:function(a,
b,c,d){if(b<=this.CONFIG.maxDepth){var e=a.prelim+c,j=this.CONFIG.nodeAlign,f=this.CONFIG.rootOrientation,h,g;if("NORTH"==f||"SOUTH"==f)h=this.levelMaxDim[b].height,g=a.height,a.pseudo&&(a.height=h);else if("WEST"==f||"EAST"==f)h=this.levelMaxDim[b].width,g=a.width,a.pseudo&&(a.width=h);a.X=e;if(a.pseudo)if("NORTH"==f||"WEST"==f)a.Y=d;else{if("SOUTH"==f||"EAST"==f)a.Y=d+(h-g)}else a.Y="CENTER"==j?d+(h-g)/2:"TOP"==j?d+(h-g):d;if("WEST"==f||"EAST"==f)e=a.X,a.X=a.Y,a.Y=e;"SOUTH"==f?a.Y=-a.Y-g:"EAST"==
f&&(a.X=-a.X-g);0!==a.childrenCount()&&(0===a.id&&this.CONFIG.hideRootNode?this.secondWalk(a.firstChild(),b+1,c+a.modifier,d):this.secondWalk(a.firstChild(),b+1,c+a.modifier,d+h+this.CONFIG.levelSeparation));a.rightSibling()&&this.secondWalk(a.rightSibling(),b,c,d)}},positionNodes:function(){var a=this.nodeDB.getMinMaxCoord("X",null,null),b=this.nodeDB.getMinMaxCoord("Y",null,null),c=a.max-a.min,d=b.max-b.min,e=this.drawArea.clientWidth/2-(a.max-c/2),j=this.drawArea.clientHeight/2-(b.max-d/2),a=0>=
a.min+e?Math.abs(a.min):0,b=0>=b.min+j?Math.abs(b.min):0,f,h,g;this.handleOverflow(c,d);f=0;for(h=this.nodeDB.db.length;f<h;f++)if(g=this.nodeDB.get(f),!(0===g.id&&this.CONFIG.hideRootNode)){g.X+=a+(c<this.drawArea.clientWidth?e:this.CONFIG.padding);g.Y+=b+(d<this.drawArea.clientHeight?j:this.CONFIG.padding);var i=g.collapsedParent(),k=null;i?(k=i.connectorPoint(!0),g.hide(k)):g.positioned?g.show():(g.nodeDOM.style.left=g.X+"px",g.nodeDOM.style.top=g.Y+"px",g.positioned=!0);0!==g.id&&!(0===g.parent().id&&
this.CONFIG.hideRootNode)?this.setConnectionToParent(g,k):!this.CONFIG.hideRootNode&&g.drawLineThrough&&g.drawLineThroughMe()}},handleOverflow:function(a,b){var c=a<this.drawArea.clientWidth?this.drawArea.clientWidth:a+2*this.CONFIG.padding,d=b<this.drawArea.clientHeight?this.drawArea.clientHeight:b+2*this.CONFIG.padding;this._R?this._R.setSize(c,d):this._R=Raphael(this.drawArea,c,d);if("native"==this.CONFIG.scrollbar)this.drawArea.clientWidth<a&&(this.drawArea.style.overflowX="auto"),this.drawArea.clientHeight<
b&&(this.drawArea.style.overflowY="auto");else if("fancy"==this.CONFIG.scrollbar){var e=$(this.drawArea);e.hasClass("ps-container")?(e.find(".Treant").css({width:c,height:d}),e.perfectScrollbar("update")):(e=e.wrapInner('<div class="Treant"/>'),e.find(".Treant").css({width:c,height:d}),e.perfectScrollbar())}},setConnectionToParent:function(a,b){var c=a.stackParentId,d=c?this.nodeDB.get(c):a.parent(),e=b?this.getPointPathString(b):this.getPathString(d,a,c);this.connectionStore[a.id]?(c=this.connectionStore[a.id],
this.animatePath(c,e)):(c=this._R.path(e),this.connectionStore[a.id]=c,a.pseudo&&delete d.connStyle.style["arrow-end"],d.pseudo&&delete d.connStyle.style["arrow-start"],c.attr(d.connStyle.style),(a.drawLineThrough||a.pseudo)&&a.drawLineThroughMe(b))},getPointPathString:function(a){return["_M",a.x,",",a.y,"L",a.x,",",a.y,a.x,",",a.y].join(" ")},animatePath:function(a,b){a.hidden&&"_"!==b.charAt(0)&&(a.show(),a.hidden=!1);a.animate({path:"_"===b.charAt(0)?b.substring(1):b},this.CONFIG.animation.connectorsSpeed,
this.CONFIG.animation.connectorsAnimation,function(){"_"===b.charAt(0)&&(a.hide(),a.hidden=!0)})},getPathString:function(a,b,c){var d=a.connectorPoint(!0),b=b.connectorPoint(!1),e=this.CONFIG.rootOrientation,j=a.connStyle.type,f,h,g,i;if("NORTH"==e||"SOUTH"==e)f=g=(d.y+b.y)/2,h=d.x,i=b.x;else if("EAST"==e||"WEST"==e)h=i=(d.x+b.x)/2,f=d.y,g=b.y;var k=d.x+","+d.y,l=h+","+f,m=i+","+g,p=b.x+","+b.y;f=(h+i)/2+","+(f+g)/2;var n;if(c)if(c="EAST"==e||"WEST"==e?b.x+","+d.y:d.x+","+b.y,"step"==j||"straight"==
j)n=["M",k,"L",c,"L",p];else{if("curve"==j||"bCurve"==j){var q,a=a.connStyle.stackIndent;"NORTH"==e?q=b.x-a+","+(b.y-a):"SOUTH"==e?q=b.x-a+","+(b.y+a):"EAST"==e?q=b.x+a+","+d.y:"WEST"==e&&(q=b.x-a+","+d.y);n=["M",k,"L",q,"S",c,p]}}else"step"==j?n=["M",k,"L",l,"L",m,"L",p]:"curve"==j?n=["M",k,"C",l,m,p]:"bCurve"==j?n=["M",k,"Q",l,f,"T",p]:"straight"==j&&(n=["M",k,"L",k,p]);return n.join(" ")},setNeighbors:function(a,b){a.leftNeighborId=this.lastNodeOnLevel[b];a.leftNeighborId&&(a.leftNeighbor().rightNeighborId=
a.id);this.lastNodeOnLevel[b]=a.id},calcLevelDim:function(a,b){this.levelMaxDim[b]?(this.levelMaxDim[b].width<a.width&&(this.levelMaxDim[b].width=a.width),this.levelMaxDim[b].height<a.height&&(this.levelMaxDim[b].height=a.height)):this.levelMaxDim[b]={width:a.width,height:a.height}},resetLevelData:function(){this.lastNodeOnLevel=[];this.levelMaxDim=[]},root:function(){return this.nodeDB.get(0)}};var u=function(a,b){function c(a,j){var f=d.createNode(a,j,b,null);if(a.children){f.children=[];if(a.childrenDropLevel&&
0<a.childrenDropLevel)for(;a.childrenDropLevel--;){var h=l.cloneObj(f.connStyle),f=d.createNode("pseudo",f.id,b,null);f.connStyle=h;f.children=[]}h=a.stackChildren&&!d.hasGrandChildren(a)?f.id:null;null!==h&&(f.stackChildren=[]);for(var g=0,i=a.children.length;g<i;g++)null!==h?(f=d.createNode(a.children[g],f.id,b,h),g+1<i&&(f.children=[])):c(a.children[g],f.id)}}this.db=[];var d=this;b.CONFIG.animateOnInit&&(a.collapsed=!0);c(a,-1);this.createGeometries(b)};u.prototype={createGeometries:function(a){for(var b=
this.db.length;b--;)this.get(b).createGeometry(a)},get:function(a){return this.db[a]},createNode:function(a,b,c,d){a=new m(a,this.db.length,b,c,d);this.db.push(a);0<=b&&this.get(b).children.push(a.id);d&&(this.get(d).stackParent=!0,this.get(d).stackChildren.push(a.id));return a},getMinMaxCoord:function(a,b,c){for(var b=b||this.get(0),d=b.childrenCount(),c=c||{min:b[a],max:b[a]+("X"==a?b.width:b.height)};d--;){var e=b.childAt(d),j=e[a]+("X"==a?e.width:e.height),f=e[a];j>c.max&&(c.max=j);f<c.min&&(c.min=
f);this.getMinMaxCoord(a,e,c)}return c},hasGrandChildren:function(a){for(var b=a.children.length;b--;)if(a.children[b].children)return!0}};var m=function(a,b,c,d,e){this.id=b;this.parentId=c;this.treeId=d.id;this.modifier=this.prelim=0;this.stackParentId=e;this.pseudo="pseudo"===a||a.pseudo;this.image=a.image;this.link=l.createMerge(d.CONFIG.node.link,a.link);this.connStyle=l.createMerge(d.CONFIG.connectors,a.connectors);this.drawLineThrough=!1===a.drawLineThrough?!1:a.drawLineThrough||d.CONFIG.node.drawLineThrough;
this.collapsable=!1===a.collapsable?!1:a.collapsable||d.CONFIG.node.collapsable;this.collapsed=a.collapsed;this.text=a.text;this.nodeInnerHTML=a.innerHTML;this.nodeHTMLclass=(d.CONFIG.node.HTMLclass?d.CONFIG.node.HTMLclass:"")+(a.HTMLclass?" "+a.HTMLclass:"");this.nodeHTMLid=a.HTMLid};m.prototype={Tree:function(){return s.get(this.treeId)},dbGet:function(a){return this.Tree().nodeDB.get(a)},size:function(){var a=this.Tree().CONFIG.rootOrientation;if(this.pseudo)return-this.Tree().CONFIG.subTeeSeparation;
if("NORTH"==a||"SOUTH"==a)return this.width;if("WEST"==a||"EAST"==a)return this.height},childrenCount:function(){return this.collapsed||!this.children?0:this.children.length},childAt:function(a){return this.dbGet(this.children[a])},firstChild:function(){return this.childAt(0)},lastChild:function(){return this.childAt(this.children.length-1)},parent:function(){return this.dbGet(this.parentId)},leftNeighbor:function(){if(this.leftNeighborId)return this.dbGet(this.leftNeighborId)},rightNeighbor:function(){if(this.rightNeighborId)return this.dbGet(this.rightNeighborId)},
leftSibling:function(){var a=this.leftNeighbor();if(a&&a.parentId==this.parentId)return a},rightSibling:function(){var a=this.rightNeighbor();if(a&&a.parentId==this.parentId)return a},childrenCenter:function(){var a=this.firstChild(),b=this.lastChild();return a.prelim+(b.prelim-a.prelim+b.size())/2},collapsedParent:function(){var a=this.parent();return!a?!1:a.collapsed?a:a.collapsedParent()},leftMost:function(a,b){if(a>=b)return this;if(0!==this.childrenCount())for(var c=0,d=this.childrenCount();c<
d;c++){var e=this.childAt(c).leftMost(a+1,b);if(e)return e}},connectorPoint:function(a){var b=this.Tree().CONFIG.rootOrientation,c={};if(this.stackParentId)if("NORTH"==b||"SOUTH"==b)b="WEST";else if("EAST"==b||"WEST"==b)b="NORTH";"NORTH"==b?(c.x=this.pseudo?this.X-this.Tree().CONFIG.subTeeSeparation/2:this.X+this.width/2,c.y=a?this.Y+this.height:this.Y):"SOUTH"==b?(c.x=this.pseudo?this.X-this.Tree().CONFIG.subTeeSeparation/2:this.X+this.width/2,c.y=a?this.Y:this.Y+this.height):"EAST"==b?(c.x=a?this.X:
this.X+this.width,c.y=this.pseudo?this.Y-this.Tree().CONFIG.subTeeSeparation/2:this.Y+this.height/2):"WEST"==b&&(c.x=a?this.X+this.width:this.X,c.y=this.pseudo?this.Y-this.Tree().CONFIG.subTeeSeparation/2:this.Y+this.height/2);return c},pathStringThrough:function(){var a=this.connectorPoint(!0),b=this.connectorPoint(!1);return["M",a.x+","+a.y,"L",b.x+","+b.y].join(" ")},drawLineThroughMe:function(a){var b=a?this.Tree().getPointPathString(a):this.pathStringThrough();this.lineThroughMe=this.lineThroughMe||
this.Tree()._R.path(b);b=l.cloneObj(this.connStyle.style);delete b["arrow-start"];delete b["arrow-end"];this.lineThroughMe.attr(b);a&&(this.lineThroughMe.hide(),this.lineThroughMe.hidden=!0)},addSwitchEvent:function(a){var b=this;l.addEvent(a,"click",function(){b.toggleCollapse()})},toggleCollapse:function(){var a=this.Tree();a.inAnimation||(a.inAnimation=!0,(this.collapsed=!this.collapsed)?$(this.nodeDOM).addClass("collapsed"):$(this.nodeDOM).removeClass("collapsed"),a.positionTree(),setTimeout(function(){a.inAnimation=
!1},a.CONFIG.animation.nodeSpeed>a.CONFIG.animation.connectorsSpeed?a.CONFIG.animation.nodeSpeed:a.CONFIG.animation.connectorsSpeed))},hide:function(a){this.nodeDOM.style.overflow="hidden";var b=$(this.nodeDOM),c=this.Tree(),d=c.CONFIG,e={left:a.x,top:a.y};this.hidden||(e.width=e.height=0);if(!this.startW||!this.startH)this.startW=b.width(),this.startH=b.height();!this.positioned||this.hidden?(this.nodeDOM.style.visibility="hidden",b.css(e),this.positioned=!0):b.animate(e,d.animation.nodeSpeed,d.animation.nodeAnimation,
function(){this.style.visibility="hidden"});this.lineThroughMe&&(b=c.getPointPathString(a),this.hidden?this.lineThroughMe.attr({path:b}):c.animatePath(this.lineThroughMe,c.getPointPathString(a)));this.hidden=!0},show:function(){this.nodeDOM.style.visibility="visible";var a={left:this.X,top:this.Y},b=this.Tree(),c=b.CONFIG;this.hidden&&(a.width=this.startW,a.height=this.startH);$(this.nodeDOM).animate(a,c.animation.nodeSpeed,c.animation.nodeAnimation,function(){this.style.overflow=""});this.lineThroughMe&&
b.animatePath(this.lineThroughMe,this.pathStringThrough());this.hidden=!1}};m.prototype.createGeometry=function(a){if(0===this.id&&a.CONFIG.hideRootNode)this.height=this.width=0;else{var b=a.drawArea,c,d=this.link.href?document.createElement("a"):document.createElement("div");d.className=!this.pseudo?m.CONFIG.nodeHTMLclass:"pseudo";this.nodeHTMLclass&&!this.pseudo&&(d.className+=" "+this.nodeHTMLclass);this.nodeHTMLid&&(d.id=this.nodeHTMLid);this.link.href&&(d.href=this.link.href,d.target=this.link.target);
if(!this.pseudo){if(this.nodeInnerHTML)if("#"===this.nodeInnerHTML.charAt(0)){var e=document.getElementById(this.nodeInnerHTML.substring(1));e?(d=e.cloneNode(!0),d.id+="-clone",d.className+=" node"):d.innerHTML="<b> Wrong ID selector </b>"}else d.innerHTML=this.nodeInnerHTML;else if(this.image&&(c=document.createElement("img"),c.src=this.image,d.appendChild(c)),this.text)for(e in this.text)m.CONFIG.textClass[e]&&(c=document.createElement(this.text[e].href?"a":"p"),this.text[e].href&&(c.href=this.text[e].href,
this.text[e].target&&(c.target=this.text[e].target)),c.className=m.CONFIG.textClass[e],c.appendChild(document.createTextNode(this.text[e].val?this.text[e].val:this.text[e]instanceof Object?"'val' param missing!":this.text[e])),d.appendChild(c));if(this.collapsed||this.collapsable&&this.childrenCount()&&!this.stackParentId)e=document.createElement("a"),e.className="collapse-switch",d.appendChild(e),this.addSwitchEvent(e),this.collapsed&&(d.className+=" collapsed")}b.appendChild(d);this.width=d.offsetWidth;
this.height=d.offsetHeight;this.nodeDOM=d;a.imageLoader.processNode(this)}};r.CONFIG={maxDepth:100,rootOrientation:"NORTH",nodeAlign:"CENTER",levelSeparation:30,siblingSeparation:30,subTeeSeparation:30,hideRootNode:!1,animateOnInit:!1,animateOnInitDelay:500,padding:15,scrollbar:"native",connectors:{type:"curve",style:{stroke:"black"},stackIndent:15},node:{link:{target:"_self"}},animation:{nodeSpeed:450,nodeAnimation:"linear",connectorsSpeed:450,connectorsAnimation:"linear"}};m.CONFIG={nodeHTMLclass:"node",
textClass:{name:"node-name",title:"node-title",desc:"node-desc",contact:"node-contact"}};var w=0,x={make:function(a){var b=a.length,c;for(this.jsonStructure={chart:null,nodeStructure:null};b--;)c=a[b],c.hasOwnProperty("container")?this.jsonStructure.chart=c:!c.hasOwnProperty("parent")&&!c.hasOwnProperty("container")&&(this.jsonStructure.nodeStructure=c,c.myID=this.getID());this.findChildren(a);return this.jsonStructure},findChildren:function(a){for(var b=[0];b.length;){for(var c=b.pop(),d=this.findNode(this.jsonStructure.nodeStructure,
c),e=0,j=a.length,f=[];e<j;e++){var h=a[e];h.parent&&h.parent.myID==c&&(h.myID=this.getID(),delete h.parent,f.push(h),b.push(h.myID))}f.length&&(d.children=f)}},findNode:function(a,b){var c,d;if(a.myID===b)return a;if(a.children)for(c=a.children.length;c--;)if(d=this.findNode(a.children[c],b))return d},getID:function(){return w++}},v=function(a,b){a instanceof Array&&(a=x.make(a));var c=s.createTree(a);c.positionTree(b);this.tree_id=c.id};v.prototype.destroy=function(){s.destroy(this.tree_id)};window.Treant=
v})();
